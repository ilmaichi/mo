// --- GESTIONE SENSORI MOBILE (FIX ANDROID/CHROME) ---
function requestGyro() {
    // Controllo per iOS 13+
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(response => {
                if (response == 'granted') {
                    window.addEventListener('deviceorientation', handleOrientation, true);
                }
            })
            .catch(console.error);
    } else {
        // Per Android e browser che non richiedono permessi espliciti
        // Usiamo 'deviceorientationabsolute' se disponibile, altrimenti 'deviceorientation'
        if ('ondeviceorientationabsolute' in window) {
            window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        } else if ('ondeviceorientation' in window) {
            window.addEventListener('deviceorientation', handleOrientation, true);
        }
    }
}

function handleOrientation(event) {
    hasGyro = true;
    
    // Su alcuni dispositivi Android i valori possono essere nulli inizialmente
    if (event.gamma === null || event.beta === null) return;

    // x: rotazione intorno all'asse Y (sinistra/destra)
    // y: rotazione intorno all'asse X (fronte/retro)
    let x = event.gamma; 
    let y = event.beta;

    // Fix per orientamento landscape o valori invertiti su alcuni Android
    if (window.orientation === 90) {
        let temp = x; x = -y; y = temp;
    } else if (window.orientation === -90) {
        let temp = x; x = y; y = -temp;
    }

    // Mappatura fluida: limitiamo il raggio e applichiamo una zona morta
    const moveX = Math.max(-25, Math.min(25, x / 1.2));
    const moveY = Math.max(-25, Math.min(25, (y - 45) / 1.2));

    // Usiamo requestAnimationFrame per prestazioni migliori
    requestAnimationFrame(() => updatePupils(moveX, moveY));
}
